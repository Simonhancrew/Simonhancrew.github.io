---
layout: post
title:  "Domain Name System"
category: Computer Network
date:   2023-10-03
---

### What is Dns

简言之就是将Domain和ip相对应，类似一个电话簿

### How it works

首先明确一下，整体的逻辑可以抽象程一个CS模型，但是这其中涉及到多个服务器, 最后client看到的就是一个req->response

下述四个服务器其实就可以看作一个dns解析流程，具体步骤可以看Ref里cloudfare的文章，里面一共写了8个步骤

1. Dns解析器(dns resolver)

    dns解析器，是一个服务器，一般是由ISP提供，也可以自己搭建，这个服务器会缓存一些dns解析结果，这样可以加快dns解析的速度，这个服务器会接受client的dns请求，然后去查询缓存，如果没有，就会去查询其他的dns服务器，最后将结果返回给client

2. root name server

    dns解析器缓存未命中的时候，会去查询root name server，这个服务器是一个全球分布式的服务器，这个服务器会返回给dns解析器，下一步应该去查询哪个顶级域名服务器

3. TLD(top-level-domain) name server
  
      这个服务器会返回给dns解析器，下一步应该去查询哪个权威域名服务器


4. authoritative name server
      
      这个服务器会返回给dns解析器，查询的结果

### 递归dns解析器和迭代dns解析器

递归dns解析器和迭代dns解析器，是两种不同的dns解析器，递归dns解析器，会一直向下查询，直到查询到结果，然后返回给client，而迭代dns解析器，会一直向下查询，直到查询到权威域名服务器，然后返回给client，client再去查询权威域名服务器，直到查询到结果

在迭代DNS查询中，每个DNS查询都直接向客户端反馈另一个需要查询的DNS服务器地址，然后客户端继续查询DNS服务器，直到其中一个回复了给定域的正确IP地址为止。在递归DNS查询中，DNS服务器会向客户端提供所需的IP地址，而不是提供另一个DNS服务器的地址。递归查询的过程是：客户端向DNS服务器发送一个查询请求，DNS服务器要么返回所需的IP地址，要么返回一个错误，指出它无法解析该域名

`换句话说，客户端在递归DNS查询中进行某种形式的委任。它告诉DNS解析器，“嘿，我需要这个域的IP地址，请查清它，在没有查到它不用回复我。”而在迭代查询中，客户端告诉DNS解析器：“嘿，我需要这个域的IP地址。请在查找过程中告诉我下一个DNS服务器的地址，以便我自己查找。”`

通常递归的查找要快一点(高速缓存)。递归DNS服务器将对执行的每个查询的最终答案进行高速缓存，并将该最终答案保存一定的时间。如果另一个客户端发出相同的查询，递归DNS服务器将直接返回缓存的答案，而不是再次执行查询。这样，递归DNS服务器可以减少对其他DNS服务器的查询，从而减少网络流量并提高性能。

当然dns解析也是有缺点的，可以后续关注一下dns放大攻击和dns缓存中毒


### Attention

遇到过比较尴尬的有两点

1. 如果你用getaddrinfo，这个接口是阻塞的，会卡住你调用的线程一段时间，而且这个在操作系统里面是无缓的。大部分的实现就是开一个thread pool去做dns解析(libuv)。而libevent自己实现了协议，和io复用一个逻辑，但是遇到C++可能有生存周期的问题，这也是比较尴尬的另一点。

2. 我遇到过dns解析，从发起解析到解析报错结束，这中间可能过了几分钟，这种情况下，其实dns解析应该考虑一个超时处理

### Ref

+ [cloudfare: what is dns](https://www.cloudflare.com/zh-cn/learning/dns/what-is-dns/)

+ [dns implement](https://github.com/jvns/dns-weekend)
